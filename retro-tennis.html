<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acetime</title>
    <style>
        @font-face {
            font-family: 'PressStart';
            src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap') format('woff2');
        }
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #111;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
        }
        #title {
            font-size: 48px;
            color: #ff00ff;
            text-shadow: 4px 4px #00ffff;
            margin-bottom: 10px;
        }
        canvas {
            border: 4px solid #00ffff;
            background-color: #000;
        }
        #info {
            font-size: 12px;
            color: #00ff00;
            margin: 10px 0;
            text-align: center;
        }
        #controls {
            display: flex;
            gap: 10px;
            margin: 5px 0;
            flex-wrap: nowrap;
        }
        .difficultyButton, #pauseButton, #playAgainButton {
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            padding: 8px 12px;
            background-color: #ff00ff;
            color: #00ffff;
            border: 2px solid #00ffff;
            cursor: pointer;
        }
        .difficultyButton.active {
            background-color: #00ff00;
            color: #000;
        }
        .difficultyButton:hover, #pauseButton:hover, #playAgainButton:hover {
            background-color: #00ffff;
            color: #ff00ff;
        }
        #playAgainButton {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1 id="title">Acetime</h1>
    <canvas id="gameCanvas" width="600" height="400"></canvas>
    <div id="info">Först till 10 (med minst 2 poängs marginal). Tryck mellanslag eller knappen för att pausa. 1-4 för svårighetsgrad.</div>
    <div id="controls">
        <button id="pauseButton">Pausa</button>
        <button class="difficultyButton active" data-level="beginner">Nybörjare</button>
        <button class="difficultyButton" data-level="medium">Medel</button>
        <button class="difficultyButton" data-level="good">Bra</button>
        <button class="difficultyButton" data-level="nadal">Nadal</button>
    </div>
    <button id="playAgainButton">Spela</button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const pauseButton = document.getElementById('pauseButton');
        const difficultyButtons = document.querySelectorAll('.difficultyButton');
        const playAgainButton = document.getElementById('playAgainButton');

        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 10,
            speedX: 3,
            speedY: 3,
            bounces: 0,
            color: '#fff'
        };

        const player = {
            x: 50,
            y: canvas.height / 2 - 50,
            width: 10,
            height: 100,
            speed: 5,
            score: 0
        };

        const computer = {
            x: canvas.width - 60,
            y: canvas.height / 2 - 50,
            width: 10,
            height: 100,
            speed: 2,
            reaction: 0.3,
            score: 0
        };

        let playerMovingUp = false;
        let playerMovingDown = false;
        let startTime = null;
        let pausedTime = 0;
        let lastPauseStart = null;
        let gameOver = false;
        let isPaused = false;
        let resultMessage = null;
        let resultTimer = 0;
        let currentDifficulty = 'beginner';
        const MAX_BALL_SPEED = 12;

        const difficulties = {
            beginner: { speed: 2, reaction: 0.3, ballSpeed: 3, ballColor: '#fff' },
            medium: { speed: 4, reaction: 0.6, ballSpeed: 4, ballColor: '#0ff' },
            good: { speed: 6, reaction: 0.8, ballSpeed: 5, ballColor: '#ff0' },
            nadal: { speed: 8, reaction: 1.0, ballSpeed: 6, ballColor: '#f00' }
        };

        function updateDifficulty(level) {
            computer.speed = difficulties[level].speed;
            computer.reaction = difficulties[level].reaction;
            const newBallSpeed = difficulties[level].ballSpeed;
            const speedRatio = newBallSpeed / Math.sqrt(ball.speedX * ball.speedX + ball.speedY * ball.speedY);
            ball.speedX *= speedRatio;
            ball.speedY *= speedRatio;
            ball.color = difficulties[level].ballColor;
            currentDifficulty = level;
            difficultyButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.level === level);
            });
        }

        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => updateDifficulty(button.dataset.level));
        });
        updateDifficulty('beginner');

        document.addEventListener('keydown', (e) => {
            if (e.key === '1') updateDifficulty('beginner');
            if (e.key === '2') updateDifficulty('medium');
            if (e.key === '3') updateDifficulty('good');
            if (e.key === '4') updateDifficulty('nadal');
            if (e.key === 'ArrowUp') playerMovingUp = true;
            if (e.key === 'ArrowDown') playerMovingDown = true;
            if (e.key === ' ') togglePause();
        });
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp') playerMovingUp = false;
            if (e.key === 'ArrowDown') playerMovingDown = false;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const touchY = touch.clientY - canvas.offsetTop;
            player.y = touchY - player.height / 2;
        });

        pauseButton.addEventListener('click', togglePause);
        playAgainButton.addEventListener('click', () => {
            resetGame();
            playAgainButton.style.display = 'none';
        });

        function togglePause() {
            if (gameOver) return;
            isPaused = !isPaused;
            pauseButton.textContent = isPaused ? 'Fortsätt' : 'Pausa';
            if (isPaused) {
                lastPauseStart = Date.now();
            } else if (lastPauseStart) {
                pausedTime += Date.now() - lastPauseStart;
                lastPauseStart = null;
            }
        }

        async function fetchHighscores() {
            try {
                const response = await fetch('http://localhost:3000/highscores');
                if (!response.ok) throw new Error(`HTTP-fel: ${response.status}`);
                const highscores = await response.json();
                updateHighscoreDisplay(highscores);
                return highscores;
            } catch (error) {
                console.error('Kunde inte hämta highscores:', error);
                highscores = []; // Tom lista vid fel
                updateHighscoreDisplay(highscores);
                return [];
            }
        }

        async function saveHighscore(name, time) {
            try {
                const response = await fetch('http://localhost:3000/highscores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, time, date: new Date().toLocaleDateString('sv-SE') })
                });
                if (!response.ok) throw new Error(`HTTP-fel: ${response.status}`);
                const highscores = await response.json();
                updateHighscoreDisplay(highscores);
            } catch (error) {
                console.error('Kunde inte spara highscore:', error);
            }
        }

        function checkWinCondition() {
            const endTime = Date.now();
            const timeTaken = ((endTime - startTime - pausedTime) / 1000).toFixed(1);
            if (player.score >= 10 && player.score - computer.score >= 2) {
                gameOver = true;
                fetchHighscores().then(highscores => {
                    const minScore = highscores.length < 20 ? Infinity : Math.max(...highscores.map(h => h.time));
                    if (highscores.length < 20 || timeTaken < minScore) {
                        const name = prompt(`Grattis! Du vann på ${timeTaken}! Ange ditt namn:`);
                        if (name) saveHighscore(name, timeTaken);
                        resultMessage = `Du vann! Din tid: ${timeTaken}`;
                    } else {
                        resultMessage = `Du vann! Din tid: ${timeTaken} - ingen topp-20-placering denna gång, försök igen!`;
                        playAgainButton.style.display = 'block';
                    }
                    resultTimer = Date.now() + 3000;
                });
            } else if (computer.score >= 10 && computer.score - player.score >= 2) {
                gameOver = true;
                resultMessage = `Du förlorade! Din tid: ${timeTaken} - ingen topp-20-placering denna gång, försök igen!`;
                playAgainButton.style.display = 'block';
                resultTimer = Date.now() + 3000;
            }
        }

        function resetGame() {
            player.score = 0;
            computer.score = 0;
            resetBall();
            startTime = Date.now();
            pausedTime = 0;
            gameOver = false;
            isPaused = false;
            pauseButton.textContent = 'Pausa';
            resultMessage = null;
            resultTimer = 0;
            fetchHighscores();
        }

        let highscores = [];
        function updateHighscoreDisplay(scores) {
            highscores = scores.slice(0, 20); // Begränsa till topp 20
        }

        function update() {
            if (!startTime) startTime = Date.now();
            if (gameOver || isPaused) return;

            if (playerMovingUp && player.y > 0) player.y -= player.speed;
            if (playerMovingDown && player.y < canvas.height - player.height) player.y += player.speed;

            const targetY = ball.y - computer.height / 2;
            const adjustedTargetY = computer.y + (targetY - computer.y) * computer.reaction;
            if (adjustedTargetY > computer.y && computer.y < canvas.height - computer.height) {
                computer.y += computer.speed;
            }
            if (adjustedTargetY < computer.y && computer.y > 0) {
                computer.y -= computer.speed;
            }

            ball.x += ball.speedX;
            ball.y += ball.speedY;

            if (
                (ball.x - ball.radius < player.x + player.width && ball.x + ball.radius > player.x && 
                 ball.y > player.y && ball.y < player.y + player.height) ||
                (ball.x + ball.radius > computer.x && ball.x - ball.radius < computer.x + computer.width && 
                 ball.y > computer.y && ball.y < computer.y + computer.height)
            ) {
                ball.speedX = -ball.speedX;
                ball.bounces++;
                ball.speedX *= 1.1;
                ball.speedY *= 1.1;
                if (currentDifficulty !== 'nadal') {
                    const currentSpeed = Math.sqrt(ball.speedX * ball.speedX + ball.speedY * ball.speedY);
                    if (currentSpeed > MAX_BALL_SPEED) {
                        const ratio = MAX_BALL_SPEED / currentSpeed;
                        ball.speedX *= ratio;
                        ball.speedY *= ratio;
                    }
                }
            }

            if (ball.x + ball.radius < 0) {
                computer.score++;
                resetBall();
            } else if (ball.x - ball.radius > canvas.width) {
                player.score++;
                resetBall();
            }

            if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
                ball.speedY = -ball.speedY;
            }

            checkWinCondition();

            if (resultTimer && Date.now() > resultTimer && !playAgainButton.style.display.includes('block')) {
                resetGame();
            }
        }

        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            const baseSpeed = difficulties[currentDifficulty].ballSpeed;
            ball.speedX = (ball.speedX > 0 ? baseSpeed : -baseSpeed);
            ball.speedY = baseSpeed;
            ball.bounces = 0;
            ball.color = difficulties[currentDifficulty].ballColor;
        }

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#fff';
            for (let i = 0; i < canvas.height; i += 20) {
                ctx.fillRect(canvas.width / 2 - 1, i, 2, 10);
            }

            ctx.fillStyle = '#0ff';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            ctx.fillStyle = '#f0f';
            ctx.fillRect(computer.x, computer.y, computer.width, computer.height);
            ctx.fillStyle = ball.color;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();

            ctx.font = '32px "Press Start 2P"';
            ctx.fillText(player.score, canvas.width / 4, 50);
            ctx.fillText(computer.score, 3 * canvas.width / 4, 50);

            if (startTime && !gameOver) {
                let currentTime;
                if (isPaused && lastPauseStart) {
                    currentTime = ((lastPauseStart - startTime - pausedTime) / 1000).toFixed(1);
                } else {
                    currentTime = ((Date.now() - startTime - pausedTime) / 1000).toFixed(1);
                }
                ctx.fillStyle = '#00ff00';
                ctx.font = '16px "Press Start 2P"';
                ctx.fillText(`Tid: ${currentTime}`, canvas.width / 2 - 60, 30);
            }

            // Rita topplistan i övre högra hörnet
            ctx.fillStyle = '#00ff00';
            ctx.font = '10px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Topplista', canvas.width - 10, 20);
            if (highscores.length === 0) {
                ctx.fillText('Inga poäng än', canvas.width - 10, 35);
            } else {
                highscores.forEach((entry, index) => {
                    const text = `${index + 1}. ${entry.name} - ${entry.time}`;
                    ctx.fillText(text, canvas.width - 10, 35 + index * 12);
                });
            }
            ctx.textAlign = 'left'; // Återställ textjustering

            if (isPaused) {
                ctx.fillStyle = '#ff00ff';
                ctx.font = '24px "Press Start 2P"';
                ctx.fillText('PAUSAD', canvas.width / 2 - 60, canvas.height / 2);
            }

            if (resultMessage) {
                ctx.fillStyle = '#ff00ff';
                ctx.font = '16px "Press Start 2P"';
                const lines = resultMessage.split(' - ');
                lines.forEach((line, index) => {
                    ctx.fillText(line, canvas.width / 2 - ctx.measureText(line).width / 2, canvas.height / 2 - 20 + index * 20);
                });
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        fetchHighscores().then(() => console.log('Highscores laddade vid start'));
        gameLoop();
    </script>
</body>
</html>